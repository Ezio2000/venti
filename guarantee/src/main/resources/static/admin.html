<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>保函系统-管理员</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
      background-color: #f8f9fa;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    .header {
      background-color: #2c3e50;
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
      text-align: left;
    }
    .header p {
      margin: 5px 0 0;
      opacity: 0.9;
      text-align: left;
    }
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .card {
      background-color: white;
      border-radius: 5px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .card h2 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      font-size: 22px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 15px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
      font-size: 16px;
    }
    button:hover {
      background-color: #2980b9;
    }
    .btn-primary {
      background-color: #3498db;
    }
    .btn-success {
      background-color: #2ecc71;
    }
    .btn-success:hover {
      background-color: #27ae60;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 15px;
    }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      font-weight: 600;
      font-size: 16px;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .response-area {
      margin-top: 25px;
      padding: 20px;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .result-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-label {
      font-weight: 600;
      color: #495057;
      display: inline-block;
      min-width: 100px;
    }
    .result-value {
      color: #2c3e50;
    }
    .tab-container {
      display: flex;
      margin-bottom: 25px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 12px 25px;
      background-color: #e9ecef;
      margin-right: 5px;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      font-weight: 500;
      transition: all 0.3s;
    }
    .tab:hover {
      background-color: #dee2e6;
    }
    .tab.active {
      background-color: white;
      border-bottom: 3px solid #3498db;
      font-weight: 600;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .status-valid {
      color: #2ecc71;
      font-weight: 600;
    }
    .status-invalid {
      color: #e74c3c;
      font-weight: 600;
    }
    .status-pending {
      color: #f39c12;
      font-weight: 600;
    }
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-col {
      flex: 1;
    }
    .success-message {
      color: #2ecc71;
      font-weight: 600;
      margin-top: 15px;
    }
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      .tab {
        padding: 10px 15px;
        font-size: 14px;
      }
      th, td {
        padding: 10px;
        font-size: 14px;
      }
    }
    /* 保持原有样式不变，新增以下样式 */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-edit {
      background-color: #f39c12;
    }
    .btn-edit:hover {
      background-color: #e67e22;
    }
    .btn-delete {
      background-color: #e74c3c;
    }
    .btn-delete:hover {
      background-color: #c0392b;
    }
    .btn-submit {
      background-color: #2ecc71;
    }
    .btn-submit:hover {
      background-color: #27ae60;
    }
    .editable {
      background-color: #fffde7;
    }
    .editable input, .editable select {
      background-color: white;
      border: 1px solid #ddd;
      padding: 8px;
      width: calc(100% - 16px);
    }
  </style>
</head>
<body>
<div class="header">
  <div class="header-content">
    <h1>保函管理系统-管理员</h1>
    <p>专业、高效的保函业务管理平台</p>
  </div>
</div>

<div class="main-content">
  <div class="tab-container">
    <div class="tab active" onclick="switchTab('register')">保函开立</div>
    <div class="tab" onclick="switchTab('verify')">保函查询</div>
    <div class="tab" onclick="switchTab('viewAll')">保函列表</div>
  </div>

  <div id="register" class="tab-content active">
    <div class="card">
      <h2>新保函开立申请</h2>
      <form id="addForm">
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="beneficiary">受益人：</label>
              <input type="text" id="beneficiary" required placeholder="请输入受益人全称">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="guaranteedParty">被担保人：</label>
              <input type="text" id="guaranteedParty" required placeholder="请输入被担保人全称">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="projectName">项目名称：</label>
              <input type="text" id="projectName" required placeholder="请输入关联项目名称">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="guaranteeAmount">保函金额：</label>
              <input type="number" id="guaranteeAmount" step="0.01" required placeholder="请输入保函金额">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="guaranteeDeadline">有效期至：</label>
              <input type="datetime-local" id="guaranteeDeadline" required>
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="guarantor">担保人：</label>
              <input type="text" id="guarantor" required placeholder="请输入担保人名称">
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="guaranteeNumber">保函编号：</label>
              <input type="text" id="guaranteeNumber" required placeholder="请输入保函编号">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="securityCode">验证码：</label>
              <input type="text" id="securityCode" required placeholder="请输入验证码">
            </div>
          </div>
        </div>

        <button type="button" class="btn-success" onclick="addGuarantee()">提交保函申请</button>
      </form>

      <div class="response-area" id="addResponse" style="display: none;">
        <h3>开立结果</h3>
        <div id="addResultContent"></div>
      </div>
    </div>
  </div>

  <div id="verify" class="tab-content">
    <div class="card">
      <h2>保函查询</h2>
      <form id="getForm">
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="getGuaranteeNumber">保函编号：</label>
              <input type="text" id="getGuaranteeNumber" required placeholder="请输入保函编号">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="getSecurityCode">验证码：</label>
              <input type="text" id="getSecurityCode" required placeholder="请输入验证码">
            </div>
          </div>
        </div>

        <button type="button" class="btn-primary" onclick="getGuarantee()">查询保函</button>
      </form>

      <div class="response-area" id="getResponse" style="display: none;">
        <h3>查询结果</h3>
        <div id="getResultContent"></div>
      </div>
    </div>
  </div>

  <div id="viewAll" class="tab-content">
    <div class="card">
      <h2>保函列表</h2>
      <button type="button" class="btn-primary" onclick="getAllGuarantees()">刷新列表</button>

      <div id="allGuaranteesTable" style="margin-top: 20px; overflow-x: auto;">
        <table>
          <thead>
          <tr>
            <th>保函编号</th>
            <th>验证码</th>
            <th>受益人</th>
            <th>被担保人</th>
            <th>担保人</th>
            <th>项目名称</th>
            <th>金额(元)</th>
            <th>有效期</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="guaranteesTableBody">
          <tr>
            <td colspan="9">点击"刷新列表"加载保函信息</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
  }

  function formatDateTime(dateTimeString) {
      if (!dateTimeString) return '未设置';
      const date = new Date(dateTimeString);
      return date.toLocaleString('zh-CN');
  }

  function formatCurrency(amount) {
      return '¥' + parseFloat(amount).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function addGuarantee() {
      const guarantee = {
          beneficiary: document.getElementById('beneficiary').value,
          guaranteedParty: document.getElementById('guaranteedParty').value,
          projectName: document.getElementById('projectName').value,
          guaranteeAmount: parseFloat(document.getElementById('guaranteeAmount').value),
          guaranteeDeadline: document.getElementById('guaranteeDeadline').value,
          guarantor: document.getElementById('guarantor').value
      };

      const verification = {
          guaranteeNumber: document.getElementById('guaranteeNumber').value,
          securityCode: document.getElementById('securityCode').value
      };

      const data = {
          guarantee: guarantee,
          guaranteeVerification: verification
      };

      fetch('/guarantee/v1/add', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
          const responseArea = document.getElementById('addResponse');
          const contentArea = document.getElementById('addResultContent');

          contentArea.innerHTML = `
              <div class="success-message">保函开立成功！</div>
              <div class="result-item">
                  <span class="result-label">保函编号：</span>
                  <span class="result-value">${data.guaranteeVerification.guaranteeNumber}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">验证码：</span>
                  <span class="result-value">${data.guaranteeVerification.securityCode}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">受益人：</span>
                  <span class="result-value">${data.guarantee.beneficiary}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">被担保人：</span>
                  <span class="result-value">${data.guarantee.guaranteedParty}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">项目名称：</span>
                  <span class="result-value">${data.guarantee.projectName}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">保函金额：</span>
                  <span class="result-value">${formatCurrency(data.guarantee.guaranteeAmount)}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">有效期至：</span>
                  <span class="result-value">${formatDateTime(data.guarantee.guaranteeDeadline)}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">担保人：</span>
                  <span class="result-value">${data.guarantee.guarantor}</span>
              </div>
          `;

          responseArea.style.display = 'block';
          document.getElementById('addForm').reset();
          getAllGuarantees();
      })
      .catch(error => {
          const responseArea = document.getElementById('addResponse');
          const contentArea = document.getElementById('addResultContent');

          contentArea.innerHTML = `
              <div class="result-item" style="color: #e74c3c;">
                  <span class="result-label">错误：</span>
<!--                  <span class="result-value">${error.message || '保函开立失败'}</span>-->
                  <span class="result-value">保函开立失败</span>
              </div>
          `;

          responseArea.style.display = 'block';
      });
  }

  function getGuarantee() {
      const data = {
          guaranteeNumber: document.getElementById('getGuaranteeNumber').value,
          securityCode: document.getElementById('getSecurityCode').value
      };

      fetch('/guarantee/v1/get', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
          const responseArea = document.getElementById('getResponse');
          const contentArea = document.getElementById('getResultContent');

          contentArea.innerHTML = `
              <div class="result-item">
                  <span class="result-label">保函编号：</span>
                  <span class="result-value">${data.guaranteeVerification.guaranteeNumber}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">验证码：</span>
                  <span class="result-value">${data.guaranteeVerification.securityCode}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">受益人：</span>
                  <span class="result-value">${data.guarantee.beneficiary}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">被担保人：</span>
                  <span class="result-value">${data.guarantee.guaranteedParty}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">项目名称：</span>
                  <span class="result-value">${data.guarantee.projectName}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">保函金额：</span>
                  <span class="result-value">${formatCurrency(data.guarantee.guaranteeAmount)}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">有效期至：</span>
                  <span class="result-value">${formatDateTime(data.guarantee.guaranteeDeadline)}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">担保人：</span>
                  <span class="result-value">${data.guarantee.guarantor}</span>
              </div>
              <div class="result-item">
                  <span class="result-label">状态：</span>
                  <span class="result-value ${getStatusClass(data.guaranteeVerification.status)}">${getStatusText(data.guaranteeVerification.status)}</span>
              </div>
          `;

          responseArea.style.display = 'block';
      })
      .catch(error => {
          const responseArea = document.getElementById('getResponse');
          const contentArea = document.getElementById('getResultContent');

          contentArea.innerHTML = `
              <div class="result-item" style="color: #e74c3c;">
                  <span class="result-label">错误：</span>
<!--                  <span class="result-value">${error.message || '保函查询失败'}</span>-->
                  <span class="result-value">保函查询失败</span>
              </div>
          `;

          responseArea.style.display = 'block';
      });
  }

  function getStatusClass(status) {
      switch(status) {
          case 'VALID': return 'status-valid';
          case 'INVALID': return 'status-invalid';
          case 'PENDING': return 'status-pending';
          default: return '';
      }
  }

  function getStatusText(status) {
      switch(status) {
          case 'VALID': return '有效';
          case 'INVALID': return '失效';
          case 'PENDING': return '处理中';
          default: return status;
      }
  }

  function getAllGuarantees() {
      fetch('/guarantee/v1/all', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          }
      })
      .then(response => response.json())
      .then(data => {
          const tableBody = document.getElementById('guaranteesTableBody');
          tableBody.innerHTML = '';

          if (data.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="8">暂无保函数据</td></tr>';
              return;
          }

          data.forEach(guarantee => {
              const row = document.createElement('tr');

              row.innerHTML = `
                  <td>${guarantee.guaranteeVerification ? guarantee.guaranteeVerification.guaranteeNumber : '未提供'}</td>
                  <td>${guarantee.guaranteeVerification ? guarantee.guaranteeVerification.securityCode : '未提供'}</td>
                  <td>${guarantee.guarantee.beneficiary}</td>
                  <td>${guarantee.guarantee.guaranteedParty}</td>
                  <td>${guarantee.guarantee.guarantor}</td>
                  <td>${guarantee.guarantee.projectName}</td>
                  <td>${formatCurrency(guarantee.guarantee.guaranteeAmount)}</td>
                  <td>${formatDateTime(guarantee.guarantee.guaranteeDeadline)}</td>
              `;
              tableBody.appendChild(row);
          });
      })
      .catch(error => {
          document.getElementById('guaranteesTableBody').innerHTML =
              `<tr><td colspan="8">数据加载失败: ${error.message}</td></tr>`;
      });
  }
  // 保持原有JavaScript代码不变，新增以下函数
  function createEditableField(value, name) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = value;
      input.name = name;
      return input;
  }

  function createEditableDateField(value, name) {
      const input = document.createElement('input');
      input.type = 'datetime-local';
      input.value = value ? new Date(value).toISOString().slice(0, 16) : '';
      input.name = name;
      return input;
  }

  function createEditableNumberField(value, name) {
      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.01';
      input.value = value;
      input.name = name;
      return input;
  }

  function enableRowEdit(row, guarantee) {
      row.classList.add('editable');

      // 保存原始数据
      row.dataset.originalData = JSON.stringify(guarantee);

      // 创建可编辑字段
      const cells = row.cells;
      cells[2].innerHTML = '';
      cells[2].appendChild(createEditableField(guarantee.guarantee.beneficiary, 'beneficiary'));

      cells[3].innerHTML = '';
      cells[3].appendChild(createEditableField(guarantee.guarantee.guaranteedParty, 'guaranteedParty'));

      cells[4].innerHTML = '';
      cells[4].appendChild(createEditableField(guarantee.guarantee.guarantor, 'guarantor'));

      cells[5].innerHTML = '';
      cells[5].appendChild(createEditableField(guarantee.guarantee.projectName, 'projectName'));

      cells[6].innerHTML = '';
      cells[6].appendChild(createEditableNumberField(guarantee.guarantee.guaranteeAmount, 'guaranteeAmount'));

      cells[7].innerHTML = '';
      cells[7].appendChild(createEditableDateField(guarantee.guarantee.guaranteeDeadline, 'guaranteeDeadline'));

      // 修改操作按钮
      const actionCell = cells[8];
      actionCell.innerHTML = '';

      const submitBtn = document.createElement('button');
      submitBtn.className = 'btn-submit';
      submitBtn.textContent = '提交';
      submitBtn.onclick = () => submitRowEdit(row, guarantee);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn-delete';
      cancelBtn.textContent = '取消';
      cancelBtn.onclick = () => cancelRowEdit(row);

      actionCell.appendChild(submitBtn);
      actionCell.appendChild(cancelBtn);
  }

  function cancelRowEdit(row) {
      const originalData = JSON.parse(row.dataset.originalData);
      renderGuaranteeRow(row, originalData);
  }

  function submitRowEdit(row, originalGuarantee) {
      const updatedGuarantee = {
          guaranteeVerification: {
              guaranteeNumber: originalGuarantee.guaranteeVerification.guaranteeNumber,
              securityCode: originalGuarantee.guaranteeVerification.securityCode
          },
          guarantee: {
              beneficiary: row.cells[2].querySelector('input').value,
              guaranteedParty: row.cells[3].querySelector('input').value,
              guarantor: row.cells[4].querySelector('input').value,
              projectName: row.cells[5].querySelector('input').value,
              guaranteeAmount: parseFloat(row.cells[6].querySelector('input').value),
              guaranteeDeadline: row.cells[7].querySelector('input').value
          }
      };

      fetch('/guarantee/v1/update', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedGuarantee)
      })
      .then(response => response.json())
      .then(data => {
          alert('保函更新成功！');
          getAllGuarantees();
      })
      .catch(error => {
          alert('保函更新失败: ' + error.message);
          getAllGuarantees();
      });
  }

  function deleteGuarantee(guaranteeNumber, securityCode) {
      if (!confirm('确定要删除此保函吗？')) return;

      fetch('/guarantee/v1/delete', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              guaranteeNumber: guaranteeNumber,
              securityCode: securityCode
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.ok == true) {
              alert('保函删除成功！');
              getAllGuarantees();
          } else {
              alert('保函删除失败！');
          }
      })
      .catch(error => {
          alert('保函删除失败: ' + error.message);
      });
  }

  function renderGuaranteeRow(row, guarantee) {
      row.innerHTML = `
          <td>${guarantee.guaranteeVerification ? guarantee.guaranteeVerification.guaranteeNumber : '未提供'}</td>
          <td>${guarantee.guaranteeVerification ? guarantee.guaranteeVerification.securityCode : '未提供'}</td>
          <td>${guarantee.guarantee.beneficiary}</td>
          <td>${guarantee.guarantee.guaranteedParty}</td>
          <td>${guarantee.guarantee.guarantor}</td>
          <td>${guarantee.guarantee.projectName}</td>
          <td>${formatCurrency(guarantee.guarantee.guaranteeAmount)}</td>
          <td>${formatDateTime(guarantee.guarantee.guaranteeDeadline)}</td>
          <td class="action-buttons">
              <button class="btn-edit" onclick="enableRowEdit(this.parentNode.parentNode, ${escapeHtml(JSON.stringify(guarantee))})">编辑</button>
              <button class="btn-delete" onclick="deleteGuarantee('${guarantee.guaranteeVerification.guaranteeNumber}', '${guarantee.guaranteeVerification.securityCode}')">删除</button>
          </td>
      `;
  }

  function escapeHtml(unsafe) {
      return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
  }

  function getAllGuarantees() {
      fetch('/guarantee/v1/all', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          }
      })
      .then(response => response.json())
      .then(data => {
          const tableBody = document.getElementById('guaranteesTableBody');
          tableBody.innerHTML = '';

          if (data.length === 0) {
              tableBody.innerHTML = '<tr><td colspan="9">暂无保函数据</td></tr>';
              return;
          }

          data.forEach(guarantee => {
              const row = document.createElement('tr');
              renderGuaranteeRow(row, guarantee);
              tableBody.appendChild(row);
          });
      })
      .catch(error => {
          document.getElementById('guaranteesTableBody').innerHTML =
              `<tr><td colspan="9">数据加载失败: ${error.message}</td></tr>`;
      });
  }
</script>
</body>
</html>